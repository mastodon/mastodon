name: Build security nightly container image
on:
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  compute-suffix:
    runs-on: ubuntu-latest
    steps:
      - id: version_vars
        env:
          TZ: Etc/UTC
        run: |
          echo mastodon_version_prerelease=nightly.$(date --date='next day' +'%Y-%m-%d')-security>> $GITHUB_OUTPUT
    outputs:
      prerelease: ${{ steps.version_vars.outputs.mastodon_version_prerelease }}

  compute-prefix:
    runs-on: ubuntu-latest
    steps:
      - id: repository_vars
        env:
          config_mastodon_image_name: ${{ vars.MASTODON_IMAGE_NAME }}
          config_mastodon_streaming_image_name: ${{ vars.MASTODON_STREAMING_IMAGE_NAME }}
        run: |
          # If custom image names are configured, use them; otherwise, default to both
          # Docker Hub (tootsuite) and GitHub Container Registry (ghcr.io) for wider distribution
          if [ -n "$config_mastodon_image_name" ]; then
            {
              echo 'image_name<<EOF'
              echo "$config_mastodon_image_name"
              echo 'EOF'
            } >> "$GITHUB_OUTPUT"
          else
            {
              echo 'image_name<<EOF'
              echo 'tootsuite/mastodon'
              echo 'ghcr.io/mastodon/mastodon'
              echo 'EOF'
            } >> "$GITHUB_OUTPUT"
          fi

          if [ -n "$config_mastodon_streaming_image_name" ]; then
            {
              echo 'streaming_image_name<<EOF'
              echo "$config_mastodon_streaming_image_name"
              echo 'EOF'
            } >> "$GITHUB_OUTPUT"
          else
            {
              echo 'streaming_image_name<<EOF'
              echo 'tootsuite/mastodon-streaming'
              echo 'ghcr.io/mastodon/mastodon-streaming'
              echo 'EOF'
            } >> "$GITHUB_OUTPUT"
          fi

    outputs:
      image_name: ${{ steps.repository_vars.outputs.image_name }}
      streaming_image_name: ${{ steps.repository_vars.outputs.streaming_image_name }}

  build-image:
    needs: [compute-suffix, compute-prefix]
    uses: ./.github/workflows/build-container-image.yml
    with:
      file_to_build: Dockerfile
      cache: false
      push_to_images: |
        ${{ needs.compute-prefix.outputs.image_name }}
      version_prerelease: ${{ needs.compute-suffix.outputs.prerelease }}
      labels: |
        org.opencontainers.image.description=Nightly build image used for testing purposes
      flavor: |
        latest=auto
      tags: |
        type=raw,value=edge
        type=raw,value=nightly
        type=raw,value=${{ needs.compute-suffix.outputs.prerelease }}
    secrets: inherit

  build-image-streaming:
    needs: [compute-suffix, compute-prefix]
    uses: ./.github/workflows/build-container-image.yml
    with:
      file_to_build: streaming/Dockerfile
      cache: false
      push_to_images: |
        ${{ needs.compute-prefix.outputs.streaming_image_name }}
      version_prerelease: ${{ needs.compute-suffix.outputs.prerelease }}
      labels: |
        org.opencontainers.image.description=Nightly build image used for testing purposes
      flavor: |
        latest=auto
      tags: |
        type=raw,value=edge
        type=raw,value=nightly
        type=raw,value=${{ needs.compute-suffix.outputs.prerelease }}
    secrets: inherit
